{% extends "base.html" %}

{% block title %}View Customer - {{ customer.name }}{% endblock %}

{% block content %}
<h1>Customer Details</h1>
<div class="customer-details-container">
    <div class="customer-info-pane">
        <h2>Customer Info</h2>
        <p><strong>Name:</strong> {{ customer.name }}</p>
        <p><strong>Email:</strong> {{ customer.email }}</p>
        <p><strong>Company:</strong> {{ customer.company or 'N/A' }}</p>
        <p><strong>Phone:</strong> {{ customer.phone or 'N/A' }}</p>
    </div>
    <div class="address-pane">
        <h2>Billing Address</h2>
        <p>{{ customer.billing_address | nl2br }}</p>
    </div>
    <div class="address-pane">
        <h2>Shipping Address</h2>
        <p>{{ customer.shipping_address | nl2br }}</p>
    </div>
</div>

<h2>Orders</h2>
<div id="ordersGrid" class="ag-theme-alpine" style="width: 100%;"></div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/customer_orders/{{ customer.id }}')
        .then(response => response.json())
        .then(data => {
            var gridOptions = {
                columnDefs: [
                    {
                    headerName: '',
                    field: 'delete',
                    cellRenderer: function(params) {
                        return '<i class="fas fa-trash text-danger delete-sale" style="cursor: pointer;"></i>';
                    },
                    onCellClicked: function(params) {
                        if (confirm("Are you sure you want to delete this sale?")) {
                            deleteSale(params.data.id);
                        }
                    },
                    maxWidth: 40,
                    sortable: false,
                    filter: false,
                    resizable: false,
                    suppressAutoSize: true,
                    suppressSizeToFit: true
                    },
                    {
                    headerName: '',
                    field: 'edit',
                    cellRenderer: function(params) {
                        return '<i class="fas fa-edit text-primary" style="cursor: pointer;"></i>';
                    },
                    onCellClicked: function(params) {
                        window.location.href = "/sales/edit/" + params.data.id;
                    },
                    maxWidth: 40,
                    sortable: false,
                    filter: false,
                    resizable: false,
                    suppressAutoSize: true,
                    suppressSizeToFit: true
                    },
                    {
                    headerName: '',
                    field: 'print',
                    cellRenderer: function(params) {
                        return '<i class="fas fa-print text-primary" style="cursor: pointer;"></i>';
                    },
                    onCellClicked: function(params) {
                        window.open("/sales/print/" + params.data.id, '_blank');
                    },
                    maxWidth: 40,
                    sortable: false,
                    filter: false,
                    resizable: false,
                    suppressAutoSize: true,
                    suppressSizeToFit: true
                    },
                    {
                    headerName: 'Date',
                    field: 'date',
                    filter: 'agDateColumnFilter',
                    comparator: dateComparator,
                    filterParams: {
                        comparator: function(filterLocalDateAtMidnight, cellValue) {
                            var dateParts = cellValue.split('-');
                            var cellDate = new Date(Number(dateParts[0]), Number(dateParts[1]) - 1, Number(dateParts[2]));

                            if (cellDate < filterLocalDateAtMidnight) {
                                return -1;
                            } else if (cellDate > filterLocalDateAtMidnight) {
                                return 1;
                            } else {
                                return 0;
                            }
                        },
                        buttons: ["apply", "reset"],
                        closeOnApply: true
                    },
                    valueFormatter: function(params) {
                        var dateParts = params.value.split('-');
                        return `${dateParts[1]}-${dateParts[2]}-${dateParts[0]}`;
                    }
                    },
                    { headerName: 'Total', field: 'total', sortable: true, filter: true, valueFormatter: currencyFormatter },
                    { headerName: 'Tax', field: 'tax', sortable: true, filter: true, valueFormatter: currencyFormatter },
                    { headerName: 'Shipping', field: 'shipping', sortable: true, filter: true, valueFormatter: currencyFormatter },
                    { headerName: 'Items', field: 'items', sortable: true, filter: true }
                ],
                defaultColDef: {
                    flex: 1,
                    //minWidth: 100,
                    resizable: true,
                    filterParams: {
                        buttons: ["apply", "reset"],
                        closeOnApply: true
                    }
                },
                rowData: data,
                domLayout: 'autoHeight',
                autoSizeStrategy: {
                    type: "fitCellContents",
                },
                onRowClicked: function(params) {
                    if (!params.event.target.classList.contains('delete-sale') && !params.event.target.classList.contains('fa-edit') && !params.event.target.classList.contains('fa-print')) {
                    window.location.href = "/sales/view/" + params.data.id;
                    }
                }
            };

            function currencyFormatter(params) {
                return '$' + params.value.toFixed(2);
            }

            function caseInsensitiveComparator(valueA, valueB) {
                if (valueA == null) return valueB == null ? 0 : -1;
                if (valueB == null) return 1;
                return valueA.toString().toLowerCase().localeCompare(valueB.toString().toLowerCase());
            }

            function dateComparator(date1, date2) {
                var dateParts1 = date1.split('-');
                var dateParts2 = date2.split('-');

                var d1 = new Date(dateParts1[2], dateParts1[0] - 1, dateParts1[1]);
                var d2 = new Date(dateParts2[2], dateParts2[0] - 1, dateParts2[1]);

                if (d1 < d2) return -1;
                if (d1 > d2) return 1;
                return 0;
            }

            function getDateFilterRange() {
                var filterModel = gridOptions.api.getFilterModel();
                if (filterModel && filterModel.date) {
                    var model = filterModel.date;
                    var fromDate = model.dateFrom ? new Date(model.dateFrom).toLocaleDateString('en-CA') : null;
                    var toDate = model.dateTo ? new Date(model.dateTo).toLocaleDateString('en-CA') : fromDate;
                    return { fromDate, toDate };
                }
                return null;
            }

            var gridDiv = document.querySelector('#ordersGrid');
            new agGrid.Grid(gridDiv, gridOptions);
        })
        .catch(error => console.error('Error:', error));
});

function deleteSale(saleId) {
    $.ajax({
        url: "/sales/delete/" + saleId,
        method: "POST",
        success: function(response) {
            if (response.success) {
                location.reload();
            } else {
                alert("Error deleting sale");
            }
        }
    });
}

</script>
{% endblock %}