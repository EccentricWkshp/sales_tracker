{% extends "base.html" %}

{% block title %}State Taxes{% endblock %}

{% block content %}
<h1>State Taxes</h1>
<div class="filter-controls">
    <label for="quarterSelect">Quarter:</label>
    <select id="quarterSelect">
        <option value="Q1">Q1 (Jan-Mar)</option>
        <option value="Q2">Q2 (Apr-Jun)</option>
        <option value="Q3">Q3 (Jul-Sep)</option>
        <option value="Q4">Q4 (Oct-Dec)</option>
    </select>
 
    <label for="yearSelect">Year:</label>
    <select id="yearSelect"></select>

    <button id="applyFilter">Apply Filter</button>
</div>
<div id="stateTaxesGrid" class="ag-theme-alpine" style="height: 600px; width: 100%;"></div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Populate year dropdown
    var currentYear = new Date().getFullYear();
    var yearSelect = document.getElementById('yearSelect');
    for (var i = currentYear; i >= currentYear - 5; i--) {
        var option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        yearSelect.appendChild(option);
    }

    // Set default selections
    function setDefaultSelections() {
        var currentDate = new Date();
        var currentMonth = currentDate.getMonth();
        var currentQuarter = Math.floor(currentMonth / 3);
        var previousQuarter = (currentQuarter - 1 + 4) % 4; // Ensure it's always 0-3
        
        yearSelect.value = currentYear;
        document.getElementById('quarterSelect').selectedIndex = previousQuarter;
    }

    setDefaultSelections();

    var gridOptions = {
        domLayout: "autoHeight",
        columnDefs: [
            { 
                headerName: 'Date',
                field: 'date',
                sortable: true,
                filter: 'agDateColumnFilter',
                filterParams: {
                    comparator: function(filterLocalDateAtMidnight, cellValue) {
                        if (!cellValue) return -1;
                        var dateParts = cellValue.split('-');
                        var cellDate = new Date(Number(dateParts[0]), Number(dateParts[1]) - 1, Number(dateParts[2]));

                        if (cellDate < filterLocalDateAtMidnight) {
                            return -1;
                        } else if (cellDate > filterLocalDateAtMidnight) {
                            return 1;
                        } else {
                            return 0;
                        }
                    },
                    buttons: ['apply', 'reset'],
                    closeOnApply: true
                },
                valueFormatter: function(params) {
                    if (!params.value) return '';
                    var dateParts = params.value.split('-');
                    return `${dateParts[1]}-${dateParts[2]}-${dateParts[0]}`;
                }
            },
            { headerName: 'Name', field: 'name', sortable: true, filter: true },
            { headerName: 'State/Country', field: 'state', sortable: true, filter: true },
            { headerName: 'Manufacturing', field: 'manufacturing', sortable: true, filter: 'agNumberColumnFilter', valueFormatter: currencyFormatter },
            { headerName: 'Retail', field: 'retail', sortable: true, filter: 'agNumberColumnFilter', valueFormatter: currencyFormatter },
            { headerName: 'Shipping', field: 'shipping', sortable: true, filter: 'agNumberColumnFilter', valueFormatter: currencyFormatter },
            { headerName: 'Items', field: 'items', sortable: true, filter: true }
        ],
        defaultColDef: {
            flex: 1,
            minWidth: 100,
            resizable: true,
            filter: true,
            filterParams: {
                buttons: ['apply', 'reset'],
                closeOnApply: true
            }
        },
        rowModelType: 'infinite',
        datasource: {
            getRows: function (params) {
                console.log('Fetching data...');
                var year = yearSelect.value;
                var quarter = document.getElementById('quarterSelect').value;
                
                var url = new URL('/api/state_taxes_data', window.location.origin);
                url.searchParams.append('year', year);
                url.searchParams.append('quarter', quarter);
                url.searchParams.append('start', params.startRow);
                url.searchParams.append('end', params.endRow);

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        console.log('Data received:', data);
                        setTimeout(() => {
                            params.successCallback(data.rows, data.lastRow);
                            if (params.startRow === 0) {
                                gridApi.sizeColumnsToFit();
                            }
                        }, 0);
                    })
                    .catch(error => {
                        console.error('Error fetching data:', error);
                        params.failCallback();
                    });
            }
        },
        cacheBlockSize: 100,
        maxBlocksInCache: 10,
        autoSizeStrategy: {
            type: "fitCellContents",
        },
        onGridReady: function(params) {
            params.api.sizeColumnsToFit();
        },
        onGridSizeChanged: function(params) {
            params.api.sizeColumnsToFit();
        }
    };

    function currencyFormatter(params) {
        if (params.value === null || params.value === undefined) return '';
        return '$' + params.value.toFixed(2);
    }

    var gridDiv = document.querySelector('#stateTaxesGrid');
    var gridApi = agGrid.createGrid(gridDiv, gridOptions);

    document.getElementById('applyFilter').addEventListener('click', function() {
        setTimeout(() => {
            gridApi.purgeInfiniteCache();
        }, 0);
    });

    //window.addEventListener('resize', function() {
    //    setTimeout(function() {
    //        gridApi.sizeColumnsToFit();
    //    });
    //});
});
</script>
{% endblock %}